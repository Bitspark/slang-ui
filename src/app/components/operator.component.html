<div>
  <h2>Operator "{{operatorName}}"</h2>
</div>

<div>
  <button (click)="save()">Save</button>
  <button (click)="showYAML = !showYAML">Toggle YAML</button>
  <button (click)="showInOutPorts = !showInOutPorts">Toggle In & Out ports</button>
</div>

<div *ngIf="showYAML">
  <div>
    <h3>YAML view</h3>
  </div>
  <div style="border: 1px dotted black; width: 1000px">
    <codemirror [ngModel]="yamlRepr"
                [config]="editorConfig"
                (ngModelChange)="updateYaml($event)"
                (blur)="storeYaml()">
    </codemirror>
  </div>
</div>

<div style="padding: 2px" *ngIf="showInOutPorts && mainSrvPort">
  <h4>
    IN
  </h4>
  <div style="display: inline-block">
    <app-type-def-form [(typeDef)]="mainSrvPort.in" (typeDefChange)="refresh()"></app-type-def-form>
  </div>
  <h4>
    OUT
  </h4>
  <div style="display: inline-block">
    <app-type-def-form [(typeDef)]="mainSrvPort.out" (typeDefChange)="refresh()"></app-type-def-form>
  </div>
</div>

<div>
  <div>
    <h3>Visual view</h3>
  </div>
  <div>
    <div
      style="width: 1000px; height: 800px; overflow: scroll; display: inline-block; border: 1px dotted black; background-color: grey">
      <svg [attr.width]="2000*scale" [attr.height]="2000*scale" style="background-color: white"
           viewBox="0 0 2000 2000"
           xmlns:svg="http://www.w3.org/2000/svg"
           (mousedown)="startDrag($event)"
           (mouseup)="stopDrag($event)"
           (mousemove)="drag($event)">

        <svg:g *ngIf="operator" [attr.transform]="transform(operator)">
          <svg:rect x="0" y="0" [attr.width]="operator.getWidth()" [attr.height]="operator.getHeight()"
                    fill="transparent"
                    [attr.stroke]="operator === selectedEntity.entity ? 'red' : 'orange'" stroke-dasharray="3 3"
                    stroke-width="3"
                    (mousedown)="selectInstance(operator)"></svg:rect>
          <svg:g *ngFor="let dlg of operator.getDelegates()" [attr.transform]="transform(dlg)">
            <svg:g [attr.transform]="transform(dlg.getIn())" app-port [port]="dlg.getIn()" (select)="selectPort($event)"
                   [selectedEntity]="selectedEntity"></svg:g>
            <svg:g [attr.transform]="transform(dlg.getOut())" app-port [port]="dlg.getOut()"
                   (select)="selectPort($event)" [selectedEntity]="selectedEntity"></svg:g>
          </svg:g>
          <svg:g [attr.transform]="transform(operator.getMainIn())" app-port [port]="operator.getMainIn()"
                 (select)="selectPort($event)" [selectedEntity]="selectedEntity"></svg:g>
          <svg:g [attr.transform]="transform(operator.getMainOut())" app-port [port]="operator.getMainOut()"
                 (select)="selectPort($event)" [selectedEntity]="selectedEntity"></svg:g>

          <svg:g *ngFor="let ins of visualInstances()" [attr.transform]="transform(ins)">
            <svg:rect x="0" y="0" [attr.width]="ins.getWidth()" [attr.height]="ins.getHeight()" fill="orange"
                      [attr.stroke]="ins === selectedEntity.entity ? 'red' : ''" stroke-dasharray="3 3" stroke-width="2"
                      (mousedown)="selectInstance(ins)"></svg:rect>
            <svg:text text-anchor="middle" x="65" y="35" fill="white" font-family="Arial" font-size="16"
                      style="pointer-events: none">{{ins.getName()}}
            </svg:text>
            <svg:g *ngFor="let dlg of ins.getDelegates()" [attr.transform]="transform(dlg)">
              <svg:g [attr.transform]="transform(dlg.getIn())" app-port [port]="dlg.getIn()"
                     (select)="selectPort($event)" [selectedEntity]="selectedEntity"></svg:g>
              <svg:g [attr.transform]="transform(dlg.getOut())" app-port [port]="dlg.getOut()"
                     (select)="selectPort($event)" [selectedEntity]="selectedEntity"></svg:g>
            </svg:g>
            <svg:g [attr.transform]="transform(ins.getMainIn())" app-port [port]="ins.getMainIn()"
                   (select)="selectPort($event)" [selectedEntity]="selectedEntity"></svg:g>
            <svg:g [attr.transform]="transform(ins.getMainOut())" app-port [port]="ins.getMainOut()"
                   (select)="selectPort($event)" [selectedEntity]="selectedEntity"></svg:g>
          </svg:g>
        </svg:g>
        <svg:line *ngFor="let conn of visualConnections()"
                  stroke-width="2px"
                  (click)="selectConnection(conn)"
                  [attr.stroke]="conn === selectedEntity.entity ? 'red' : 'black'"
                  [attr.x1]="conn.getSource().getPortPosX()"
                  [attr.y1]="conn.getSource().getPortPosY()"
                  [attr.x2]="conn.getDestination().getPortPosX()"
                  [attr.y2]="conn.getDestination().getPortPosY()"></svg:line>
      </svg>
    </div>
    <div
      style="border: 1px dotted black; display: inline-block; height: 780px; overflow: scroll; margin-left: 20px; padding: 10px">
      <div>
        <label for="opSearch" style="font-size: 10px">Search operators</label><br>
        <input id="opSearch" [(ngModel)]="filterString">
        <h3>Local operators</h3>
        <ul>
          <li *ngFor="let op of getLocals(filterString)">{{ op.getName() }}
            <button (click)="addInstance(op)">+</button>
          </li>
        </ul>
        <h3>Elementary operators</h3>
        <ul>
          <li *ngFor="let op of getElementaries(filterString)">{{ op.getName() }}
            <button (click)="addInstance(op)">+</button>
          </li>
        </ul>
        <h3>Library operators</h3>
        <ul>
          <li *ngFor="let op of getLibraries(filterString)">{{ op.getName() }}
            <button (click)="addInstance(op)">+</button>
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>

<div *ngIf="isInstanceSelected()">
  <h3>Instance: {{ selectedEntity.entity.getName() }}</h3>
  <h4>Generics ({{ genericNames().length }})</h4>
  <ul>
    <li *ngFor="let genName of genericNames()">{{ genName }}</li>
  </ul>
</div>

<div>
  Status: {{status}}
</div>
